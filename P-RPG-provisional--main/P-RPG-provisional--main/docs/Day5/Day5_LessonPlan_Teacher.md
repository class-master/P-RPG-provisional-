# Day5：フィールド → バトル → フィールドの一連の流れ（7人×3時間用シナリオ）

## 0. 今日のゴール（先生が最初に読む用）

3時間で、次の「一連の流れ」を **クラス全体で完成させる** ことを目標にします。

1. フィールド画面（Day1/Day2）がすでに動いている前提
2. Day3 の「NPC と会話イベント」から、バトル開始イベントを呼び出せる
3. バトル画面（Day4 の `BattleWindow`）で  
   - プレイヤーと敵の HP を表示  
   - A キーで攻撃 → 敵の HP が減る  
   - 敵の反撃でプレイヤーの HP が減る  
4. 敵を倒したらフィールドに戻る（勝利メッセージを出す）
5. プレイヤーが倒れたら HP を全回復してフィールドに戻る

> **Day5 のテーマ**  
> - 「モード切り替え（field / battle）」という考え方を、実際のプロジェクトに組み込む  
> - 「データ（JSON）」「ロジック（Python）」「画面（Kivy）」の **3つをつなぐ** 経験をする  

---

## 絶対ルール（先生からクラスへ説明）

- `main_day1.py` / `main_day2.py` は **書き換え禁止**
- 触ってよいファイルは、プリントに書いてある場所だけ
- 分からなくなったら  
  1. プリントに戻る  
  2. それでもダメなら先生に聞く  
- Git 管理の場合は、**1タスクごとにコミット**（Day5 のバトル用ブランチを切ってもよい）

---

## 1. 役割分担（7人×3時間）

| 記号 | 役割名              | 触るファイル / ディレクトリ                 | 具体的な仕事のイメージ                                  |
|------|---------------------|----------------------------------------------|--------------------------------------------------------|
| A    | ステータス担当      | `status_day4.py`                             | `Status` クラスにコメントを追加し、HP まわりの振る舞いを整理する |
| B    | 敵データ担当        | `input/enemies_day4.json`                    | 敵の種類・HP・攻撃力などを設計し、JSON データを整える         |
| C    | バトル計算担当      | `battle_engine.py`                           | ダメージ計算ロジックとメッセージ文言の調整                  |
| D    | バトルUI担当        | `ui/battle_window.py` / `ui/battle_window.kv` | HP 表示・メッセージ表示の見た目と更新処理の整理              |
| E    | バトル制御担当      | `main_day5_student.py`                       | モード切り替え・`start_battle` / `end_battle` の実装        |
| F    | フィールド接続担当  | Day3 のフィールド側コード（`main_day3.py` など） | NPC やイベントから `start_battle` を呼び出す処理を結線       |
| G    | テスト & 記録担当   | `docs/Day5/Day5_buglog.md`                  | バトルのテストと、見つかった不具合の記録・共有              |

> A〜F は「実装担当」、G は「品質担当」。  
> Day5 では、**G が全員の作業を眺めながらバグを見つけていく** 役になります。

---

## 2. 今日の時間割（板書用のたたき台）

- 0:00〜0:10　今日のゴール説明 & 役割分担（このプリントを読む）
- 0:10〜0:25　Day4 のおさらい（Status / BattleWindow / バトル計算の復習）
- 0:25〜1:15　**前半作業**：A〜F がそれぞれ担当箇所を実装、G はテスト観察
- 1:15〜1:30　中間共有：各担当が「どこまでできたか」を 3分ずつ報告
- 1:30〜2:20　**後半作業**：接続不備の修正・バランス調整・バグ修正
- 2:20〜2:40　最終テスト（G 主導）：「倒せる敵」「負けるパターン」を一通り確認
- 2:40〜3:00　ふり返り：  
  - 良かった点（技術面 / チームワーク）  
  - 次に直したい点（設計 / タスク分担）

---

## 3. 実装の羅針盤（先生用の「全体地図」）

### 3-1. A：ステータス担当（`status_day4.py`）

- 目的：バトルで扱う「プレイヤー/敵の体力・攻撃力」の意味をはっきりさせる
- 具体的な指示例：
  - `Status` クラスの各フィールド（`name`, `max_hp`, `hp`, `attack`, `defense`）に docstring やコメントを追加
  - `take_damage()` の処理に、「0未満にはならない」「ダメージの途中計算はどこでやるか」などコメントを入れる
  - 余力があれば `heal_full()` や `heal(amount)` などのメソッドを追加しておく  
    → Day5 の敗北時に「HP を全回復してフィールドに戻す」処理で使いやすくする

### 3-2. B：敵データ担当（`input/enemies_day4.json`）

- 目的：ゲームバランスの「元データ」を作る
- 具体的な指示例：
  - JSON のフォーマットを確認（例：`"slime"`, `"bat"` などのキー）
  - 敵ごとに `name`, `max_hp`, `attack`, `defense` を設定
  - 「すぐ倒せる雑魚」「そこそこ強い敵」など、3〜4種類の強さを用意
  - 先生は事前に 1 パターン用意しておき、Bチームには「書き足し」をしてもらう形でもよい

### 3-3. C：バトル計算担当（`battle_engine.py`）

- 目的：ダメージ計算とメッセージの「気持ちよさ」を調整する
- 具体的な指示例：
  - `calc_damage()` を読み、攻撃力・防御力の意味を確認
  - 必要なら「クリティカル」や「最低ダメージ 1」などのルールをコメントで明示
  - `player_attack()` / `enemy_attack()` の docstring を厚くし、**誰が誰に何をしているか** を日本語で説明
  - メッセージのフォーマット案を決めておく  
    例：`"{attacker} のこうげき！ {defender} に {dmg} ダメージ！"`

### 3-4. D：バトルUI担当（`ui/battle_window.py` / `.kv`）

- 目的：HP とメッセージが「一目で分かる」画面を作る
- 具体的な指示例：
  - `BattleWindow` クラスの `update_status()` / `show_message()` にコメントを追加
  - `.kv` ファイルでラベルの配置を調整（**縦方向の並び** と **余白** の確保）
  - プレイヤー HP は `HP: 現在 / 最大` の形式で表示
  - 敵が倒れたとき / プレイヤーが倒れたときで、メッセージの色や表現を変える案も出してみる

### 3-5. E：バトル制御担当（`main_day5_student.py`）

- 目的：「フィールド ↔ バトル」の切り替えロジックを作る
- 実装の入口はこの 3つの関数：

  - `load_enemy_status(enemy_id: str)`  
  - `start_battle(enemy_id: str)`  
  - `end_battle(message: str)`  
  - + キー入力をさばく `handle_battle_key(key: str)` / `on_key_press(key: str)`

- 先生用の `main_day5_teacher.py` には、**参考実装と詳細コメント** を入れてあります。
- 生徒用の `main_day5_student.py` では、  
  - 関数の「役割」と  
  - どの順番で何を呼ぶか  
  が TODO とコメントで指示されている形にします。

### 3-6. F：フィールド接続担当（Day3 のフィールド側）

- 目的：NPC やイベントからバトルを開始できるようにする
- 具体的な指示例：
  - Day3 の `on_key_press()` や「話しかけたときの処理」を読む
  - 例えば、「スライムに話しかけたら `start_battle("slime")` を呼ぶ」というルールを作る
  - NPC オブジェクトに `enemy_id` を持たせてもよいし、イベント ID から敵 ID を決めてもよい
- 先生のポイント：
  - Day5 では「設計をきっちり固める」よりも、「とにかく 1 体でもいいので戦えるようになる」ことを優先
  - 余力があれば、敵ごとにセリフや勝利時のごほうびを追加

### 3-7. G：テスト & 記録担当（`docs/Day5/Day5_buglog.md`）

- 目的：**「ゲームの遊び心地」を測る最初のユーザーテスト**
- 具体的な指示例：
  - 「やってみたこと」「期待した結果」「実際に起きたこと」「メモ」を表形式で記録
  - A〜F から「テストしてほしいポイント」を集めて回る
  - 直ったバグには ✅ を付けておく（完了の見える化）

---

## 4. 先生の事前準備チェックリスト

### 4-1. ソースコード側

- [ ] `P-RPG-provisional-` プロジェクトが全員の PC で動くことを事前確認
- [ ] Day1〜Day4 のコードが **現状どうなっているか** を軽く把握しておく
- [ ] `status_day4.py` / `battle_engine.py` / `ui/battle_window.py` の内容を一度通読
- [ ] `input/enemies_day4.json` に最低 1 体ぶんの敵データを用意しておく
- [ ] `docs/Day5/Day5_Worksheet_Student.md` を印刷 or 配布準備

### 4-2. 授業運営側

- [ ] 7人分の役割（A〜G）を事前に割り振る or くじ引き用の札を用意
- [ ] 途中共有（1:15〜1:30）のときに誰から発表するか決めておく
- [ ] バトルがどうしても完成しなかった場合の「妥協ライン」を決めておく  
      （例：「敵の HP が減るところまでできたら OK」とする）

---

## 5. 授業中の声かけの例

- 「今どのモード？ field？ battle？」と、**状態を言語化** させる
- 「この JSON の数字をいじると、ゲームではどんな変化が起きる？」と、  
  データと挙動を結びつける質問をする
- 「テスト担当（G）から見ると、どこが一番こわれやすそう？」と聞いてみる

---

## 6. 授業終了後のふり返りメモ（先生用）

- 今日の Day5 で、
  - どのチームが詰まりやすかったか（A〜G）
  - どのファイルの説明が薄かったか
- 次回以降、
  - Day6 で「魔法」や「アイテム」をやるなら、どこを拡張ポイントにするか
- 気づいたことは `docs/Day5/Day5_buglog.md` の末尾に追記しておくと、  
  次のクラスでも再利用しやすくなります。
