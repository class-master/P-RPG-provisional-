�ｻｿ# -*- coding: utf-8 -*-
"""
RPG Rustic Master B 遯ｶ繝ｻDay1繝ｻ驛��ｽｬ蟶幢ｽｸ�ｽｫ騾包ｽｨ繝ｻ蜊ｯivy
陋ｻ�ｽｰ鬩戊ｲｻ�ｽｼ螢ｹ縺｡郢ｧ�ｽ､郢晢ｽｫ隰蜀怜愛繝ｻ迢暦ｽｧ�ｽｻ陷榊桁�ｽｼ蛹ｻ笘�郢ｧ鬆第｢邵ｺ蜑幸繝ｻ繝ｻ
髫暦ｽ｣驕ｲ豈費ｽｾ蜈ｷ�ｽｼ蜚ｮhift隘搾ｽｰ郢ｧ蜈ｷ�ｽｼ荳莞醍ｹ昜ｹ昴�ｻ郢昴�ｻ繝ｻHUD繝ｻ蜀玲★隴夲ｽｿ邵ｺ�ｽｮ陟冶侭笳�郢ｧ髮∵�幄楜螟ｲ�ｽｼ繝ｻABB繝ｻ繝ｻ
"""

from kivy.app import App
from kivy.uix.widget import Widget
from kivy.core.window import Window
from kivy.clock import Clock
from kivy.graphics import Color, Rectangle, PushMatrix, PopMatrix, Translate
from kivy.uix.label import Label
from kivy.properties import ListProperty

from config import WIDTH, HEIGHT, TILE_SIZE, MAP_CSV, PLAYER_SPEED, BG
from field.map_loader_kivy import load_csv_as_tilemap, load_tileset_regions


class Game(Widget):
    """
    Day1邵ｺ�ｽｮ髢繝ｻ竏ｴ隴��ｽｹ繝ｻ驛��ｽｶ繝ｻ笆｡邵ｺ繝ｻﾂｧ繝ｻ繝ｻ
    - update(): 陷茨ｽ･陷牙ｸ壹�ｻ驕假ｽｻ陷崎｣懊�ｻ郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ遶雁｣㎎aw() 邵ｺ�ｽｮ鬯�繝ｻ縲堤ｸｲ蠕後＃郢晢ｽｼ郢晢｣ｰ邵ｺ�ｽｮ霑･�ｽｶ隲ｷ荵敖髦ｪ�ｽ定ｭ厄ｽｴ隴��ｽｰ
    - draw()  : canvas 郢ｧ蜑��ｽｸﾂ隴鯉ｽｦ雎ｸ蛹ｻ�ｼ邵ｺ�ｽｦ邵ｲ竏ｽ�ｽｻ鄙ｫ繝ｻ霑･�ｽｶ隲ｷ荵晢ｽ定ｬ荳岩ｳ騾ｶ�ｽｴ邵ｺ繝ｻ
    - Day1邵ｺ�ｽｯ髯ｦ譎会ｽｪ竏壺�醍ｸｺ證ｦ�ｽｼ蛹ｻ笘�郢ｧ鬆第｢邵ｺ蜑幸繝ｻ蟲ｨ竊醍ｸｺ�ｽｮ邵ｺ�ｽｧ邵ｲ竏ｫ�ｽｧ�ｽｻ陷崎ｼ斐�ｻ邵ｲ謔滂ｽｺ�ｽｧ隶灘生�ｽ帝屆�ｽｳ邵ｺ蜷ｶ笆｡邵ｺ莉｣ﾂ髦ｪ縲丹K
    """

    cam = ListProperty([0, 0])  # [cam_x, cam_y] = 郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ陝ｾ�ｽｦ闕ｳ蜈ｷ�ｽｼ蛹ｻﾎ｡郢晢ｽｼ郢晢ｽｫ郢晉甥�ｽｺ�ｽｧ隶灘遜�ｽｼ繝ｻ

    def __init__(self, **kw):
        super().__init__(**kw)

        # ---------------------------------------------
        # 0) 騾包ｽｻ鬮ｱ�ｽ｢郢ｧ�ｽｵ郢ｧ�ｽ､郢ｧ�ｽｺ繝ｻ繝ｻidget邵ｺ�ｽｮ陞滂ｽｧ邵ｺ髦ｪ�ｼ�繝ｻ蟲ｨ�ｽ帝￡�ｽｺ陞ｳ螢ｹ笘�郢ｧ繝ｻ
        # ---------------------------------------------
        self.size = (WIDTH, HEIGHT)

        # ---------------------------------------------
        # 1) 郢晄ｧｭ繝｣郢昜ｽ全V繝ｻ繝ｻ隹ｺ�ｽ｡陷医�ｻ繝ｻ郢ｧ�ｽｿ郢ｧ�ｽ､郢晢ｽｫID鬩滓ｦ翫�ｻ繝ｻ蟲ｨ�ｽ帝坡�ｽｭ邵ｺ�ｽｿ髴趣ｽｼ郢ｧﾂ
        # ---------------------------------------------
        self.grid, self.rows, self.cols = load_csv_as_tilemap(MAP_CSV)

        # ---------------------------------------------
        # 2) 郢ｧ�ｽｿ郢ｧ�ｽ､郢晢ｽｫ郢ｧ�ｽｻ郢昴�ｻ繝ｨ繝ｻ繝ｻid -> texture繝ｻ蟲ｨ�ｽ帝坡�ｽｭ邵ｺ�ｽｿ髴趣ｽｼ郢ｧﾂ
        # ---------------------------------------------
        self.tiles = load_tileset_regions()

        # ---------------------------------------------
        # 3) 郢晄ｧｭ繝｣郢晄懊�ｻ闖ｴ阮吶�ｻ郢晄鱒縺醍ｹｧ�ｽｻ郢晢ｽｫ郢ｧ�ｽｵ郢ｧ�ｽ､郢ｧ�ｽｺ繝ｻ蛹ｻ縺咲ｹ晢ｽ｡郢晢ｽｩ邵ｺ�ｽｮ陋ｻ�ｽｶ鬮ｯ闊娯�楢抄�ｽｿ邵ｺ繝ｻ�ｽｼ繝ｻ
        # ---------------------------------------------
        self.ts = TILE_SIZE
        self.map_w = self.cols * self.ts
        self.map_h = self.rows * self.ts

        # ---------------------------------------------
        # 4) 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ陋ｻ譎�謔�陋滂ｽ､
        # ---------------------------------------------
        # px, py : 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ陝ｾ�ｽｦ闕ｳ蜿･�ｽｺ�ｽｧ隶灘遜�ｽｼ蛹ｻﾎ｡郢晢ｽｼ郢晢ｽｫ郢晉甥�ｽｺ�ｽｧ隶灘遜�ｽｼ繝ｻ
        # w, h   : 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ驕擾ｽｩ陟厄ｽ｢郢ｧ�ｽｵ郢ｧ�ｽ､郢ｧ�ｽｺ繝ｻ繝ｻay1邵ｺ�ｽｧ邵ｺ�ｽｯ陟冶侭笳�郢ｧ髮∵�幄楜螢ｹ�ｼ邵ｺ�ｽｪ邵ｺ繝ｻ窶ｲ邵ｲ竏壹＠郢ｧ�ｽ､郢ｧ�ｽｺ邵ｺ�ｽｯ隰問�壺命繝ｻ繝ｻ
        self.px = self.ts * 2
        self.py = self.ts * 2
        self.w = self.ts - 6
        self.h = self.ts - 6

        # ---------------------------------------------
        # 5) 陷茨ｽ･陷牙ｹ｢�ｽｼ蝓滓ｬｾ邵ｺ霈費ｽ檎ｸｺ�ｽｦ邵ｺ繝ｻ�ｽ狗ｹｧ�ｽｭ郢晢ｽｼ繝ｻ閾･�ｽｮ�ｽ｡騾�繝ｻ
        # ---------------------------------------------
        # self.keys 邵ｺ�ｽｫ keycode 郢ｧ雋槭�ｻ郢ｧ蠕娯ｻ邵ｲ譴ｧ谺ｾ邵ｺ蜉ｱ笆ｲ邵ｺ�ｽｱ邵ｺ�ｽｪ邵ｺ蜉ｱﾂ髦ｪ�ｽ定楜貅ｽ讓溽ｸｺ蜷ｶ�ｽ�
        # 邵ｺ阮呻ｽ檎ｸｺ�ｽｫ郢ｧ蛹ｻ�ｽ顔ｸｲ縲継date() 陋幢ｽｴ邵ｺ�ｽｧ邵ｲ蠕｡�ｽｻ鬆第ｬｾ邵ｺ霈費ｽ檎ｸｺ�ｽｦ郢ｧ蛹ｺ蟀ｿ陷ｷ莉｣ﾂ髦ｪ�ｽ定ｱ亥ｼｱ繝ｵ郢晢ｽｬ郢晢ｽｼ郢晢｣ｰ髫ｱ�ｽｭ郢ｧ竏夲ｽ�
        self.keys = set()

        # Shift陋ｻ�ｽ､陞ｳ螢ｹ�ｽ定楜迚呻ｽｮ螢ｹ�ｼ�邵ｺ蟶吮螺邵ｺ繝ｻ繝ｻ邵ｺ�ｽｧ邵ｲ�ｼｻodifier繝ｻ莠包ｽｿ�ｽｮ鬯滂ｽｾ郢ｧ�ｽｭ郢晢ｽｼ繝ｻ蟲ｨ�ｽる囎螢ｹ竏ｴ邵ｺ�ｽｦ邵ｺ鄙ｫ�ｿ･
        # Kivy邵ｺ�ｽｮ on_key_down 邵ｺ�ｽｫ邵ｺ�ｽｯ modifier 邵ｺ�ｽｮ郢晢ｽｪ郢ｧ�ｽｹ郢晏現窶ｲ隴夲ｽ･郢ｧ蜈ｷ�ｽｼ莠包ｽｾ繝ｻ ['shift']繝ｻ繝ｻ
        self.mods = set()

        Window.bind(on_key_down=self._kd, on_key_up=self._ku)

        # ---------------------------------------------
        # 6) HUD繝ｻ閧ｲ蛻､鬮ｱ�ｽ｢陜暦ｽｺ陞ｳ螢ｹ繝ｻ郢昴�ｻ縺冗ｹｧ�ｽｹ郢晁肩�ｽｼ繝ｻ
        # ---------------------------------------------
        self.hud = Label(
            text="驕擾ｽ｢陷奇ｽｰ邵ｺ�ｽｧ驕假ｽｻ陷阪�ｻ/ Shift邵ｺ�ｽｧ隘搾ｽｰ郢ｧ繝ｻ/ 騾ｵ蛹ｺ謾ｸ邵ｺ�ｽｫ髫暦ｽｦ郢ｧ蠕鯉ｽ狗ｸｺ�ｽｨ髯ｦ�ｽｨ驕会ｽｺ / 郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晄懈価闕ｳ繝ｻ,
            pos=(12, HEIGHT - 28)
        )
        self.add_widget(self.hud)

        # ---------------------------------------------
        # 7) 騾ｵ蛹ｺ謾ｸ繝ｻ驛��ｽｧ�ｽ｣驕ｲ豈費ｽｾ蜈ｷ�ｽｼ繝ｻ
        # ---------------------------------------------
        # Day1邵ｺ�ｽｪ邵ｺ�ｽｮ邵ｺ�ｽｧ邵ｲ蠕後■郢ｧ�ｽ､郢晢ｽｫ陟趣ｽｧ隶灘生縲帝р�ｽｮ邵ｺ荳環蝮ゅ�ｻ 陋ｻ繝ｻﾂｰ郢ｧ鄙ｫ�ｽ�邵ｺ蜷ｶ�ｼ�
        # AABB陟冶侭笳�郢ｧ髮∵�幄楜螟ら舞邵ｺ�ｽｫ邵ｲ�ｽ捐s/size 郢ｧ蛛ｵﾎ｡郢晢ｽｼ郢晢ｽｫ郢晉甥�ｽｺ�ｽｧ隶灘遜�ｽｼ蛹ｻ繝ｴ郢ｧ�ｽｯ郢ｧ�ｽｻ郢晢ｽｫ繝ｻ蟲ｨ縲定将譎�謌溽ｸｺ蜷ｶ�ｽ�
        #
        # 邵ｺ阮呻ｼ�邵ｺ�ｽｧ邵ｺ�ｽｯ邵ｲ迹夲ｽｦ荵昶斡郢ｧ蜿･蝟ｧ邵ｲ髦ｪ�ｽり怦�ｽｼ邵ｺ�ｽｭ邵ｺ�ｽｦ draw() 邵ｺ�ｽｧ騾ｵ蛹ｺ謾ｸ郢ｧ螳壼沂邵ｺ荵礼ｷ帝包ｽｻ邵ｺ蜉ｱ竏ｪ邵ｺ繝ｻ
        self.signs = [
            {
                "pos": (self.ts * 6, self.ts * 3),
                "size": (self.ts, self.ts),
                "text": "騾ｵ蛹ｺ謾ｸ繝ｻ螢ｹ�ｽ育ｸｺ繝ｻ�ｼ�邵ｺ譏ｴﾂ繝ｻay1邵ｺ�ｽｯ邵ｲ蜿也ｷ帝包ｽｻ邵ｺ�ｽｨ驕假ｽｻ陷崎ｼ板荳岩ｲ邵ｺ�ｽｧ邵ｺ髦ｪ�ｽ檎ｸｺ�ｽｰ陷ｷ蝓滂｣ｰ�ｽｼ邵ｺ�ｽｪ邵ｺ�ｽｮ邵ｺ�ｽｧ邵ｺ蜷ｶﾂ繝ｻ,
            },
            {
                "pos": (self.ts * 10, self.ts * 8),
                "size": (self.ts, self.ts),
                "text": "騾ｵ蛹ｺ謾ｸ繝ｻ蜚ｮhift邵ｺ�ｽｧ隘搾ｽｰ郢ｧ蛟ｶ�ｽｾ荵晢ｽ定怦�ｽ･郢ｧ蠕娯ｻ邵ｺ繧��ｽ顔ｸｺ�ｽｾ邵ｺ蜻ｻ�ｽｼ驛��ｽｬ蟶幢ｽｸ�ｽｫ騾包ｽｨ邵ｺ�ｽｮ髫暦ｽ｣驕ｲ豈費ｽｾ蜈ｷ�ｽｼ蟲ｨﾂ繝ｻ,
            },
        ]
        self.sign_text = ""   # 闔蛾｡假ｽｧ�ｽｦ郢ｧ蠕娯ｻ邵ｺ繝ｻ�ｽ矩ｵ蛹ｺ謾ｸ郢晢ｽ｡郢昴�ｻ縺晉ｹ晢ｽｼ郢ｧ�ｽｸ繝ｻ閧ｲ笏檎ｸｺ莉｣�ｽ檎ｸｺ�ｽｰ驕ｨ�ｽｺ繝ｻ繝ｻ
        self.sign_hold = 0.0  # HUD邵ｺ蠕後Γ郢晢ｽｩ邵ｺ�ｽ､邵ｺ荵昶�醍ｸｺ繝ｻ�ｽ育ｸｺ繝ｻ竊楢氣莉｣�ｼ闖ｫ譎�謌溽ｸｺ蜷ｶ�ｽ�

        # ---------------------------------------------
        # 8) 郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晄圜�ｽｼ驛��ｽｧ�ｽ｣驕ｲ豈費ｽｾ蜈ｷ�ｽｼ螟仙ｱ∬厄ｽ｢繝ｻ繝ｻ
        # ---------------------------------------------
        # 郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晏干繝ｻ陞滂ｽｧ邵ｺ髦ｪ�ｼ�繝ｻ閧ｲ蛻､鬮ｱ�ｽ｢陷繝ｻ繝ｻ驕擾ｽｩ陟厄ｽ｢繝ｻ繝ｻ
        self.mm_w = 220
        self.mm_h = 220
        self.mm_margin = 12  # 騾包ｽｻ鬮ｱ�ｽ｢驕ｶ�ｽｯ邵ｺ荵晢ｽ臥ｸｺ�ｽｮ闖ｴ蜥丞項
        # 陷ｿ�ｽｳ闕ｳ鄙ｫ竊馴ｩ溷調�ｽｽ�ｽｮ邵ｺ蜷ｶ�ｽ九�ｻ蛹ｻﾎ醍ｹ昜ｹ昴�ｻ郢昴�ｻ繝ｻ陝ｾ�ｽｦ闕ｳ蜿･�ｽｺ�ｽｧ隶灘遜�ｽｼ繝ｻ
        self.mm_x = WIDTH - self.mm_w - self.mm_margin
        self.mm_y = HEIGHT - self.mm_h - self.mm_margin

        # ---------------------------------------------
        # 9) 郢晢ｽｫ郢晢ｽｼ郢晞斡蟷戊沂繝ｻ
        # ---------------------------------------------
        Clock.schedule_interval(self.update, 1 / 60)

    # ------------------------------------------------------------
    # 郢ｧ�ｽｭ郢晢ｽｼ陷茨ｽ･陷牙ｹ｢�ｽｼ螢ｽ谺ｾ邵ｺ蜉ｱ笳�/鬮ｮ�ｽ｢邵ｺ蜉ｱ笳� 郢ｧ蝣､諞ｾ隲ｷ荵昶�堤ｸｺ蜉ｱ窶ｻ闖ｫ譎�謌溽ｸｺ蜷ｶ�ｽ�
    # ------------------------------------------------------------
    def _kd(self, win, key, scancode, codepoint, modifier):
        """
        key      : 郢ｧ�ｽｭ郢晢ｽｼ郢ｧ�ｽｳ郢晢ｽｼ郢昜ｼ夲ｽｼ閧ｲ豕呵怺�ｽｰ郢ｧ�ｽｭ郢晢ｽｼ邵ｺ�ｽｪ郢ｧ繝ｻ273邵ｲ繝ｻ76 邵ｺ�ｽｪ邵ｺ�ｽｩ繝ｻ繝ｻ
        modifier : 闖ｫ�ｽｮ鬯滂ｽｾ郢ｧ�ｽｭ郢晢ｽｼ邵ｺ�ｽｮ郢晢ｽｪ郢ｧ�ｽｹ郢晁肩�ｽｼ莠包ｽｾ繝ｻ ['shift']繝ｻ繝ｻ
        """
        self.keys.add(key)
        # modifier 邵ｺ�ｽｯ雎井ｸｻ螻� 遯ｶ諛岩落邵ｺ�ｽｮ隴弱ｉ縺帷ｸｺ�ｽｧ隰夲ｽｼ邵ｺ霈費ｽ檎ｸｺ�ｽｦ邵ｺ繝ｻ�ｽ玖将�ｽｮ鬯滂ｽｾ郢ｧ�ｽｭ郢晢ｽｼ遯ｶ繝ｻ邵ｺ譴ｧ謫らｹｧ荵晢ｼ�邵ｺ�ｽｨ邵ｺ謔滂ｽ､螢ｹ�ｼ樒ｸｺ�ｽｮ邵ｺ�ｽｧ
        # set 邵ｺ�ｽｫ陷茨ｽ･郢ｧ蠕娯ｻ闖ｫ譎�謌溽ｸｺ蜉ｱ窶ｻ邵ｺ鄙ｫ�ｿ･繝ｻ繝ｻhift隘搾ｽｰ郢ｧ鄙ｫ繝ｻ陋ｻ�ｽ､陞ｳ螢ｹ竊楢抄�ｽｿ邵ｺ繝ｻ�ｽｼ繝ｻ
        self.mods = set(modifier) if modifier else set()
        return True

    def _ku(self, win, key, scancode):
        self.keys.discard(key)
        # key_up 邵ｺ�ｽｧ邵ｺ�ｽｯ modifier 邵ｺ譴ｧ謫らｸｺ�ｽｪ邵ｺ繝ｻ繝ｻ邵ｺ�ｽｧ邵ｲ繝ｾhift郢ｧ蟶晏ｱｬ邵ｺ蜉ｱ笳�霑ｸ�ｽｬ鬮｢阮吮�� set 邵ｺ譴ｧ�ｽｮ荵晢ｽ狗ｸｺ阮吮�堤ｸｺ蠕娯旺郢ｧ繝ｻ
        # 邵ｺ譏ｴ繝ｻ邵ｺ貅假ｽ� update() 陋幢ｽｴ邵ｺ�ｽｧ邵ｲ驛｡hift郢ｧ�ｽｭ郢晢ｽｼ郢ｧ�ｽｳ郢晢ｽｼ郢晏ｳｨ�ｽり屐蜻ｵ�ｽ｣諛岩�堤ｸｺ蜉ｱ窶ｻ髫穂ｹ晢ｽ狗ｸｲ髦ｪ�ｼ�邵ｺ�ｽｨ邵ｺ�ｽｧ陞ｳ迚吶�ｻ陋幢ｽｴ邵ｺ�ｽｫ陋溷�ｵ笘�
        return True

    # ------------------------------------------------------------
    # update繝ｻ螟ゑｽｧ�ｽｻ陷崎ｼ斐�ｻ郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ郢晢ｽｻ騾ｵ蛹ｺ謾ｸ陋ｻ�ｽ､陞ｳ螢ｹ繝ｻ隰蜀怜愛
    # ------------------------------------------------------------
    def update(self, dt):
        # ----------------------------
        # 1) 隴��ｽｹ陷ｷ螟ｧ繝ｻ陷峨�ｻ
        # ----------------------------
        left = 276
        right = 275
        up = 273
        down = 274

        ax = (1 if right in self.keys else 0) - (1 if left in self.keys else 0)
        ay = (1 if down in self.keys else 0) - (1 if up in self.keys else 0)

        # ----------------------------
        # 2) Shift隘搾ｽｰ郢ｧ螂��ｽｼ驛��ｽｧ�ｽ｣驕ｲ豈費ｽｾ蜈ｷ�ｽｼ繝ｻ
        # ----------------------------
        # modifier 邵ｺ謔溷徐郢ｧ蠕鯉ｽ玖ｿｺ�ｽｰ陟�繝ｻ縲堤ｸｺ�ｽｯ 'shift' 邵ｺ謔溘�ｻ郢ｧ繝ｻ
        # 陷ｿ謔ｶ�ｽ檎ｸｺ�ｽｪ邵ｺ繝ｻ闕ｳ讎奇ｽｮ迚呻ｽｮ螢ｹ竊題ｿｺ�ｽｰ陟�繝ｻ縲堤ｸｺ�ｽｯ邵ｲ繝ｾhift郢ｧ�ｽｭ郢晢ｽｼ郢ｧ�ｽｳ郢晢ｽｼ郢昴�ｻ303/304)郢ｧ繧�ﾂ蜻ｵ�ｽ｣諛岩�鍋ｸｺ蜷ｶ�ｽ�
        shift_keys = {303, 304}  # 霑ｺ�ｽｰ陟�繝ｻ竊鍋ｹｧ蛹ｻ�ｽ願淦�ｽｮ邵ｺ繧��ｽ翫�ｻ莠･謇ｿ/陝ｾ�ｽｦShift繝ｻ繝ｻ
        is_shift = ('shift' in self.mods) or any(k in self.keys for k in shift_keys)

        spd = PLAYER_SPEED
        if is_shift:
            # 隘搾ｽｰ郢ｧ髮�ﾂ蜥ｲ邏ｫ繝ｻ螢ｽ閧｢隶鯉ｽｭ邵ｺ�ｽｧ邵ｺ�ｽｯ 1.5邵ｲ繝ｻ.0 邵ｺ�ｽｮ驕ｽ繝ｻ蟲�邵ｺ蠕｡�ｽｽ謐ｺ笏邵ｺ蜉ｱ�ｽ�邵ｺ蜷ｶ�ｼ�
            spd = PLAYER_SPEED * 1.8

        # ----------------------------
        # 3) 驕假ｽｻ陷榊桁�ｽｼ繝ｻay1邵ｺ�ｽｯ髯ｦ譎会ｽｪ竏壺�醍ｸｺ證ｦ�ｽｼ譏ｴ笘�郢ｧ鬆第｢邵ｺ蜑幸繝ｻ繝ｻ
        # ----------------------------
        self.px += ax * spd
        self.py += ay * spd

        # 郢晄ｧｭ繝｣郢晄懶ｽ､謔ｶ竏郁怎�ｽｺ郢ｧ荵昶�帝恆�ｽｷ陝�闊娯�鍋ｸｺ�ｽｪ郢ｧ荵昴�ｻ邵ｺ�ｽｧ 遯ｶ諛域呵抄譛ｱ蜑樒ｪｶ繝ｻ邵ｺ�ｽｮ陋ｻ�ｽｶ鬮ｯ謦ｰ�ｽｼ驛��ｽｬ蟶幢ｽｸ�ｽｫ騾包ｽｨ邵ｺ�ｽｯ陷茨ｽ･郢ｧ蠕娯ｻ邵ｺ鄙ｫ�ｿ･邵ｺ�ｽｨ陞ｳ迚呻ｽｿ繝ｻ�ｽｼ繝ｻ
        # clamp繝ｻ螢ｼﾂ�ｽ､郢ｧ繝ｻmin邵ｲ蠕㌢x 邵ｺ�ｽｫ陷ｿ蠑ｱ�ｽ∫ｹｧ荵敖竏壺�堤ｸｺ繝ｻ竕ｧ隲｢荳櫁｢�
        self.px = max(0, min(self.px, self.map_w - self.w))
        self.py = max(0, min(self.py, self.map_h - self.h))

        # ----------------------------
        # 4) 郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ繝ｻ蛹ｻ繝ｻ郢晢ｽｬ郢ｧ�ｽ､郢晢ｽ､郢晢ｽｼ闕ｳ�ｽｭ陟｢繝ｻ�ｽｿ�ｽｽ陟暮屮�ｽｼ莨夲ｽｼ繝ｻ郢晄ｧｭ繝｣郢晉､ｼ�ｽｫ�ｽｯ邵ｺ�ｽｧ陋ｻ�ｽｶ鬮ｯ繝ｻ
        # ----------------------------
        # 邵ｲ蠕後�ｻ郢晢ｽｬ郢ｧ�ｽ､郢晢ｽ､郢晢ｽｼ邵ｺ讙主愛鬮ｱ�ｽ｢邵ｺ�ｽｮ騾ｵ貅假ｽ楢叉�ｽｭ邵ｺ�ｽｫ隴夲ｽ･郢ｧ荵敖髦ｪ�ｽ育ｸｺ繝ｻ竊� cam 郢ｧ蜻茨ｽｱ�ｽｺ郢ｧ竏夲ｽ�
        cx = self.px - self.width / 2
        cy = self.py - self.height / 2

        # 郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ邵ｺ蠕後�ｻ郢昴�ｻ繝ｻ陞滓じ�ｽ定ｭ擾｣ｰ邵ｺ霈披�醍ｸｺ繝ｻ�ｽ育ｸｺ繝ｻ竊楢崕�ｽｶ鬮ｯ繝ｻ
        cam_max_x = max(0, self.map_w - self.width)
        cam_max_y = max(0, self.map_h - self.height)

        self.cam[0] = max(0, min(cx, cam_max_x))
        self.cam[1] = max(0, min(cy, cam_max_y))

        # ----------------------------
        # 5) 騾ｵ蛹ｺ謾ｸ陟冶侭笳�郢ｧ髮∵�幄楜螟ｲ�ｽｼ驛��ｽｧ�ｽ｣驕ｲ豈費ｽｾ蜈ｷ�ｽｼ蜩�ABB繝ｻ繝ｻ
        # ----------------------------
        self._check_sign(dt)

        # ----------------------------
        # 6) 隰蜀怜愛
        # ----------------------------
        self.draw()

    # ------------------------------------------------------------
    # 騾ｵ蛹ｺ謾ｸ陟冶侭笳�郢ｧ髮∵�幄楜螟ｲ�ｽｼ繝ｻABB繝ｻ繝ｻ
    # ------------------------------------------------------------
    def _check_sign(self, dt):
        """
        Day1邵ｺ�ｽｪ邵ｺ�ｽｮ邵ｺ�ｽｧ邵ｲ竏壺旺邵ｺ荳岩穐邵ｺ�ｽｧ 遯ｶ諛��ｽｰ�ｽ｡隴丞�ｪﾂ繝ｻ邵ｺ�ｽｪ騾ｵ蛹ｺ謾ｸ陋ｻ�ｽ､陞ｳ螢ｹﾂ繝ｻ
        - 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ驕擾ｽｩ陟厄ｽ｢邵ｺ�ｽｨ騾ｵ蛹ｺ謾ｸ驕擾ｽｩ陟厄ｽ｢邵ｺ遒√裟邵ｺ�ｽｪ邵ｺ�ｽ｣邵ｺ貅假ｽ臥ｹ晢ｽ｡郢昴�ｻ縺晉ｹ晢ｽｼ郢ｧ�ｽｸ髯ｦ�ｽｨ驕会ｽｺ
        - 髫暦ｽｦ郢ｧ蠕娯ｻ邵ｺ繝ｻ竊醍ｸｺ繝ｻ蜃ｾ邵ｺ�ｽｯ陝�莉｣�ｼ邵ｺ�｣ｰ邵ｺ鬘鯉ｽ｡�ｽｨ驕会ｽｺ郢ｧ蜑��ｽｿ譎�謌溘�ｻ繝ｻUD邵ｺ蠕後Γ郢晢ｽｩ邵ｺ�ｽ､邵ｺ荳翫�ｻ郢ｧ蟶昜ｺ溽ｸｺ謦ｰ�ｽｼ繝ｻ
        """
        # 闖ｫ譎�謌溯ｭ弱ｋ菫｣郢ｧ蜻茨ｽｸ蟶呻ｽ臥ｸｺ繝ｻ
        self.sign_hold = max(0.0, self.sign_hold - dt)

        # 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ驕擾ｽｩ陟厄ｽ｢繝ｻ莠･�ｽｷ�ｽｦ闕ｳ繝ｻ+ 郢ｧ�ｽｵ郢ｧ�ｽ､郢ｧ�ｽｺ繝ｻ繝ｻ
        px, py, pw, ph = self.px, self.py, self.w, self.h

        hit_text = ""

        for s in self.signs:
            sx, sy = s["pos"]
            sw, sh = s["size"]

            if self._aabb_intersect(px, py, pw, ph, sx, sy, sw, sh):
                hit_text = s["text"]
                break

        if hit_text:
            self.sign_text = hit_text
            self.sign_hold = 0.20  # 0.2驕伜宴�ｽｿ譎�謌溘�ｻ蛹ｻ笙陞ゑｽｽ邵ｺ�ｽｿ邵ｺ�ｽｧ繝ｻ繝ｻ
        else:
            # 髫暦ｽｦ郢ｧ蠕娯ｻ邵ｺ繝ｻ竊醍ｸｺ繝ｻ蜃ｾ邵ｺ�ｽｯ邵ｲ竏ｽ�ｽｿ譎�謌溽ｸｺ謔溘�ｻ郢ｧ蠕娯螺郢ｧ逕ｻ�ｽｶ蛹ｻ笘�
            if self.sign_hold <= 0.0:
                self.sign_text = ""

        # HUD隴厄ｽｴ隴��ｽｰ繝ｻ蝓滂ｽｯ蠑ｱ繝ｵ郢晢ｽｬ郢晢ｽｼ郢晢｣ｰ隴厄ｽｸ邵ｺ閧ｴ驪､邵ｺ蛹ｻ窶ｻOK繝ｻ繝ｻ
        base = "驕擾ｽ｢陷奇ｽｰ邵ｺ�ｽｧ驕假ｽｻ陷阪�ｻ/ Shift邵ｺ�ｽｧ隘搾ｽｰ郢ｧ繝ｻ/ 騾ｵ蛹ｺ謾ｸ邵ｺ�ｽｫ髫暦ｽｦ郢ｧ蠕鯉ｽ狗ｸｺ�ｽｨ髯ｦ�ｽｨ驕会ｽｺ / 郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晄懈価闕ｳ繝ｻ
        if self.sign_text:
            self.hud.text = f"{base}\n邵ｲ蜊�諱夊ｭ夲ｽｿ邵ｲ謐徭elf.sign_text}"
        else:
            self.hud.text = base

    @staticmethod
    def _aabb_intersect(ax, ay, aw, ah, bx, by, bw, bh):
        """
        AABB繝ｻ驛��ｽｻ�ｽｸ邵ｺ�ｽｫ陝ｷ�ｽｳ髯ｦ蠕娯�題摎蟷��ｽｧ雋橸ｽｽ�ｽ｢繝ｻ迚咎�碑椶�ｽｫ邵ｺ�ｽｮ鬩･髦ｪ竊醍ｹｧ髮∵�幄楜螢ｹﾂ繝ｻ
        - 2邵ｺ�ｽ､邵ｺ�ｽｮ驕擾ｽｩ陟厄ｽ｢邵ｺ繝ｻ遯ｶ諞ｺ纃ｾ邵ｺ�ｽｪ邵ｺ�ｽ｣邵ｺ�ｽｦ邵ｺ繝ｻ�ｽ狗ｪｶ繝ｻ邵ｺ�ｽｪ郢ｧ繝ｻTrue
        - 邵ｺ�ｽｾ邵ｺ�ｽ｣邵ｺ貅假ｿ･鬩･髦ｪ竊醍ｸｺ�ｽ｣邵ｺ�ｽｦ邵ｺ繝ｻ竊醍ｸｺ繝ｻ竊醍ｹｧ繝ｻFalse

        郢ｧ�ｽｳ郢昴�ｻ�ｽｼ繝ｻ
        - 邵ｲ遒∝ｱｬ郢ｧ蠕娯ｻ邵ｺ繝ｻ�ｽ玖ｭ夲ｽ｡闔会ｽｶ邵ｲ髦ｪ�ｽ定惺�ｽｦ陞ｳ螢ｹ笘�郢ｧ荵昶�堤ｸｲ竏晄�幄楜螢ｹ窶ｲ隴厄ｽｸ邵ｺ髦ｪ�ｽ�邵ｺ蜷ｶ�ｼ�
        """
        # a 邵ｺ�ｽｮ陷ｿ�ｽｳ驕ｶ�ｽｯ邵ｺ繝ｻb 邵ｺ�ｽｮ陝ｾ�ｽｦ驕ｶ�ｽｯ郢ｧ蛹ｻ�ｽ願淦�ｽｦ 遶翫�ｻ鬮ｮ�ｽ｢郢ｧ蠕娯ｻ邵ｺ繝ｻ�ｽ�
        if ax + aw <= bx:
            return False
        # a 邵ｺ�ｽｮ陝ｾ�ｽｦ驕ｶ�ｽｯ邵ｺ繝ｻb 邵ｺ�ｽｮ陷ｿ�ｽｳ驕ｶ�ｽｯ郢ｧ蛹ｻ�ｽ願愾�ｽｳ 遶翫�ｻ鬮ｮ�ｽ｢郢ｧ蠕娯ｻ邵ｺ繝ｻ�ｽ�
        if ax >= bx + bw:
            return False
        # a 邵ｺ�ｽｮ闕ｳ鬘費ｽｫ�ｽｯ邵ｺ繝ｻb 邵ｺ�ｽｮ闕ｳ迢暦ｽｫ�ｽｯ郢ｧ蛹ｻ�ｽ願叉繝ｻ遶翫�ｻ鬮ｮ�ｽ｢郢ｧ蠕娯ｻ邵ｺ繝ｻ�ｽ�
        if ay + ah <= by:
            return False
        # a 邵ｺ�ｽｮ闕ｳ迢暦ｽｫ�ｽｯ邵ｺ繝ｻb 邵ｺ�ｽｮ闕ｳ鬘費ｽｫ�ｽｯ郢ｧ蛹ｻ�ｽ願叉繝ｻ遶翫�ｻ鬮ｮ�ｽ｢郢ｧ蠕娯ｻ邵ｺ繝ｻ�ｽ�
        if ay >= by + bh:
            return False

        return True

    # ------------------------------------------------------------
    # draw繝ｻ螢ｻ�ｽｻ鄙ｫ繝ｻ霑･�ｽｶ隲ｷ荵晢ｽ定ｬ荳奇ｿ･
    # ------------------------------------------------------------
    def draw(self):
        self.canvas.clear()

        with self.canvas:
            # 0) 髢ｭ譴ｧ蜍ｹ
            Color(*BG)
            Rectangle(pos=self.pos, size=self.size)

            # 1) 邵ｺ阮呻ｼ�邵ｺ荵晢ｽ� 遯ｶ諛莞｡郢晢ｽｼ郢晢ｽｫ郢晉判邱帝包ｽｻ遯ｶ繝ｻ鬮｢蜿･�ｽｧ蜈ｷ�ｽｼ蛹ｻ縺咲ｹ晢ｽ｡郢晢ｽｩ邵ｺ�ｽｧ邵ｺ螢ｹ�ｽ臥ｸｺ蜻ｻ�ｽｼ繝ｻ
            PushMatrix()
            Translate(-self.cam[0], -self.cam[1], 0)

            # 2) 郢ｧ�ｽｿ郢ｧ�ｽ､郢晢ｽｫ隰蜀怜愛
            ts = self.ts
            for r, row in enumerate(self.grid):
                for c, tid in enumerate(row):
                    # tid 邵ｺ�ｽｫ陝��ｽｾ陟｢諛岩��郢ｧ繝ｻtexture 邵ｺ讙寂伯邵ｺ繝ｻ竊帝梨�ｽｽ邵ｺ�ｽ｡郢ｧ荵昴�ｻ邵ｺ�ｽｧ邵ｲ竏ｬ�ｽｬ蟶幢ｽｸ�ｽｫ騾包ｽｨ邵ｺ�ｽｧ邵ｺ�ｽｯ陞ｳ迚吶�ｻ陋幢ｽｴ邵ｺ�ｽｫ
                    tex = self.tiles.get(tid) if hasattr(self.tiles, "get") else self.tiles[tid]
                    if tex is None:
                        continue
                    Rectangle(texture=tex, pos=(c * ts, r * ts), size=(ts, ts))

            # 3) 騾ｵ蛹ｺ謾ｸ郢ｧ螳壼沂邵ｺ荵礼ｷ帝包ｽｻ繝ｻ驕ｺﾂ諛岩落邵ｺ阮吮�鍋ｸｺ繧��ｽ狗ｪｶ譏ｴ竊定崕繝ｻﾂｰ郢ｧ荵晢ｽ育ｸｺ繝ｻ竊薙�ｻ繝ｻ
            Color(1, 1, 1, 0.25)
            for s in self.signs:
                sx, sy = s["pos"]
                sw, sh = s["size"]
                Rectangle(pos=(sx, sy), size=(sw, sh))

            # 4) 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ隰蜀怜愛
            Color(0.35, 0.67, 1, 1)
            Rectangle(pos=(self.px, self.py), size=(self.w, self.h))

            # 5) 郢晢ｽｯ郢晢ｽｼ郢晢ｽｫ郢晉判邱帝包ｽｻ邵ｺ阮呻ｼ�邵ｺ�ｽｾ邵ｺ�ｽｧ
            PopMatrix()

            # 6) 騾包ｽｻ鬮ｱ�ｽ｢陜暦ｽｺ陞ｳ螟ｲ�ｽｼ螢ｹﾎ醍ｹ昜ｹ昴�ｻ郢昴�ｻ繝ｻ繝ｻ驛��ｽｧ�ｽ｣驕ｲ豈費ｽｾ蜈ｷ�ｽｼ繝ｻ
            self._draw_minimap()

    # ------------------------------------------------------------
    # 郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晄圜�ｽｼ閧ｲ蛻､鬮ｱ�ｽ｢陜暦ｽｺ陞ｳ螢ｹ繝ｻ驍��ｽ｡隴城豪豐ｿ繝ｻ繝ｻ
    # ------------------------------------------------------------
    def _draw_minimap(self):
        """
        Day1邵ｺ�ｽｮ郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晏干繝ｻ 遯ｶ諞ｺ螻∬厄ｽ｢遯ｶ繝ｻ邵ｺ�ｽｧ陷岩�昴�ｻ邵ｺ�ｽｧ邵ｺ蜷ｶﾂ繝ｻ
        - 郢晄ｧｭ繝｣郢晄懊�ｻ闖ｴ髮｣�ｽｼ螢ｽ譽ｧ繝ｻ莠･豼鬨ｾ荵励�ｻ繝ｻ繝ｻ
        - 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ繝ｻ螟ゅ○繝ｻ莠･�ｽｰ荳奇ｼ�邵ｺ�ｽｪ陜怜ｹ��ｽｧ謚ｵ�ｽｼ繝ｻ
        - 郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ驕ｽ繝ｻ蟲�繝ｻ螢ｽ譽ｧ繝ｻ莠包ｽｻ�ｽｻ隲｢荳環繧��ｼ�邵ｺ阮吶堤ｸｺ�ｽｯ陷茨ｽ･郢ｧ蠕娯ｻ邵ｺ繧��ｽ顔ｸｺ�ｽｾ邵ｺ蜻ｻ�ｽｼ繝ｻ
        """
        # 1) 郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晏干繝ｻ隴ｫ�｣ｰ
        Color(0, 0, 0, 0.45)
        Rectangle(pos=(self.mm_x, self.mm_y), size=(self.mm_w, self.mm_h))

        Color(1, 1, 1, 0.25)
        Rectangle(pos=(self.mm_x, self.mm_y), size=(self.mm_w, self.mm_h))

        # 2) 郢晢ｽｯ郢晢ｽｼ郢晢ｽｫ郢晉甥�ｽｺ�ｽｧ隶薙�ｻ-> 郢晄ｺ倥Ν郢晄ｧｭ繝｣郢晄懶ｽｺ�ｽｧ隶灘生竏育ｸｺ�ｽｮ陞溽判驪､
        #    雎育坩邏ｫ繝ｻ蝸肺/map_w 郢ｧ繝ｻmm_w 邵ｺ�ｽｫ陷蜷ｶ笘�邵ｲ竏壺�堤ｸｺ繝ｻ竕ｧ髢繝ｻ竏ｴ隴��ｽｹ
        #    繝ｻ繝ｻap_w 邵ｺ繝ｻ0 邵ｺ�ｽｫ邵ｺ�ｽｪ郢ｧ荵晢ｼ�邵ｺ�ｽｨ邵ｺ�ｽｯ鬨ｾ螢ｼ�ｽｸ�ｽｸ邵ｺ�ｽｪ邵ｺ繝ｻ窶ｲ邵ｲ竏晢ｽｿ�ｽｵ邵ｺ�ｽｮ邵ｺ貅假ｽ� max(1, map_w)繝ｻ繝ｻ
        mw = max(1, self.map_w)
        mh = max(1, self.map_h)

        # 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ闕ｳ�ｽｭ陟｢繝ｻ�ｽ堤ｹ晄ｺ倥Ν郢晄ｧｭ繝｣郢晏干竏�
        pcx = self.px + self.w / 2
        pcy = self.py + self.h / 2

        mx = self.mm_x + (pcx / mw) * self.mm_w
        my = self.mm_y + (pcy / mh) * self.mm_h

        # 3) 郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ驕ｽ繝ｻ蟲�邵ｺ�ｽｮ隴ｫ�｣ｰ繝ｻ蛹ｻﾎ醍ｹ昜ｹ昴�ｻ郢昴�ｻ繝ｻ闕ｳ螂��ｽｼ繝ｻ
        # 郢ｧ�ｽｫ郢晢ｽ｡郢晢ｽｩ邵ｺ�ｽｮ陝ｾ�ｽｦ闕ｳ荵昶�堤ｸｲ竏ｫ蛻､鬮ｱ�ｽ｢郢ｧ�ｽｵ郢ｧ�ｽ､郢ｧ�ｽｺ陋ｻ繝ｻ�ｽ堤ｹ晄ｺ倥Ν郢晄ｧｭ繝｣郢晏干竏磯し�ｽｮ陝�荳奇ｼ邵ｺ�ｽｦ隰荳奇ｿ･
        cx = self.mm_x + (self.cam[0] / mw) * self.mm_w
        cy = self.mm_y + (self.cam[1] / mh) * self.mm_h
        cw = (self.width / mw) * self.mm_w
        ch = (self.height / mh) * self.mm_h

        Color(1, 1, 1, 0.35)
        Rectangle(pos=(cx, cy), size=(cw, ch))

        # 4) 郢晏干ﾎ樒ｹｧ�ｽ､郢晢ｽ､郢晢ｽｼ霓､�ｽｹ
        Color(0.35, 0.67, 1, 0.95)
        Rectangle(pos=(mx - 3, my - 3), size=(6, 6))


class Day1(App):
    def build(self):
        return Game()


if __name__ == "__main__":
    Day1().run()
